<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Previewer</title>
    <script src="require.js"></script>
</head>
<body>
<script>
    let bootstrap;
    let widgetModule;
    let widgetName;
    let widgetClass;

    function preview() {
        const params = new URLSearchParams(window.location.search);
        if (!params.has("a") || !params.has("v")) {
            document.body.innerText = "Bad request."
            return
        }

        const a = params.get("a")
        widgetName = params.get("v")

        widgetModule = "packages/appbox/" + a + "/views/" + widgetName + ".dart"
        widgetClass = a + "__views__" + widgetName
        requirejs(["main.dart", widgetModule], function (main, view) {
            bootstrap = main;
            const widget = view[widgetClass]
            const instance = new widget[widgetName].new()
            main.main.run(instance);
        });
    }

    function reload() {
        //TODO: can reload?
        requirejs.undef(widgetModule)
        requirejs([widgetModule], function (view) {
            const widget = view[widgetClass]
            const instance = new widget[widgetName].new()
            bootstrap.main.reload(instance)
        })
    }

    window.addEventListener("message", function (event) {
        if (event.data == "reload") reload()
    })

    preview();
</script>
</body>
</html>
